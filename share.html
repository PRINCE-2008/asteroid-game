<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WiFi Drop - Mobile Optimized</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- PeerJS -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    
    <!-- QRious -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Segoe UI', system-ui, sans-serif; touch-action: manipulation; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Mobile Tab Active State */
        .tab-active { color: #60a5fa; border-top: 2px solid #60a5fa; background: rgba(30, 41, 59, 0.5); }
        .tab-inactive { color: #94a3b8; border-top: 2px solid transparent; }

        .modal-enter { animation: modalIn 0.3s ease-out forwards; }
        @keyframes modalIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body class="h-[100dvh] flex flex-col overflow-hidden">

    <!-- Connection Request Modal -->
    <div id="request-modal" class="fixed inset-0 bg-black/80 z-[100] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-slate-800 border border-gray-600 rounded-2xl p-6 max-w-sm w-full shadow-2xl modal-enter">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-blue-600 rounded-full flex items-center justify-center mx-auto mb-4 animate-bounce">
                    <i class="fa-solid fa-link text-3xl text-white"></i>
                </div>
                <h3 class="text-xl font-bold text-white mb-2">Connection Request</h3>
                <p class="text-gray-300 text-sm">
                    <span id="request-id" class="font-mono text-blue-400">Device</span> wants to connect.
                </p>
            </div>
            <div class="flex gap-3">
                <button onclick="respondToRequest(false)" class="flex-1 py-3 rounded-xl border border-gray-600 text-gray-300 hover:bg-slate-700 font-bold">Decline</button>
                <button onclick="respondToRequest(true)" class="flex-1 py-3 rounded-xl bg-blue-600 hover:bg-blue-500 text-white font-bold shadow-lg">Accept</button>
            </div>
        </div>
    </div>

    <!-- Navbar -->
    <nav class="p-3 md:p-4 border-b border-gray-700 bg-slate-900/90 flex justify-between items-center z-10 shrink-0">
        <div class="flex items-center gap-2 md:gap-3">
            <div class="w-8 h-8 rounded bg-blue-600 flex items-center justify-center">
                <i class="fa-solid fa-wifi text-white"></i>
            </div>
            <h1 class="font-bold text-lg md:text-xl tracking-tight">WiFi<span class="text-blue-500">Drop</span></h1>
        </div>
        <div class="flex gap-2">
            <div id="role-badge" class="px-2 py-1 rounded-full text-[10px] md:text-xs font-bold bg-purple-900/30 border border-purple-500/30 text-purple-400 flex items-center gap-2">
                <i class="fa-solid fa-circle-nodes"></i><span>Init</span>
            </div>
            <div id="connection-badge" class="hidden px-2 py-1 rounded-full text-[10px] md:text-xs font-bold bg-gray-800 text-gray-400 border border-gray-700 flex items-center gap-2">
                <div class="w-2 h-2 rounded-full bg-gray-500"></div><span>Wait</span>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col md:flex-row relative overflow-hidden min-h-0">
        
        <!-- Left Panel: Discovery -->
        <div id="left-panel" class="w-full md:w-1/3 lg:w-1/4 p-4 md:p-6 bg-slate-800 border-r border-gray-700 flex flex-col gap-4 overflow-y-auto h-full pb-24 md:pb-6">
            
            <!-- Room & Settings -->
            <div class="glass p-4 rounded-xl space-y-3">
                 <div class="flex justify-between items-center">
                     <label class="text-xs uppercase font-bold text-gray-500">Network Room</label>
                     <div class="text-[10px] text-gray-400">Match codes to connect</div>
                 </div>
                 
                 <!-- Room Code Input -->
                 <div class="flex gap-2">
                     <div class="relative flex-1">
                         <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                             <i class="fa-solid fa-hashtag text-gray-500 text-xs"></i>
                         </div>
                         <input type="text" id="room-input" value="..." class="w-full bg-slate-900 border border-gray-700 rounded-lg pl-8 pr-2 py-2 text-sm text-blue-400 font-mono focus:border-blue-500 outline-none transition-colors" placeholder="Room Code">
                     </div>
                     <button onclick="applyRoomCode()" class="bg-slate-700 hover:bg-slate-600 text-white px-3 rounded-lg text-xs font-bold transition">
                         Set
                     </button>
                 </div>

                 <!-- Role Toggle -->
                 <div class="flex bg-slate-900 rounded-lg p-1 border border-gray-700">
                     <button onclick="manualSetRole('auto')" id="btn-role-auto" class="flex-1 py-1.5 text-[10px] font-bold rounded-md transition bg-blue-600 text-white">Auto</button>
                     <button onclick="manualSetRole('host')" id="btn-role-host" class="flex-1 py-1.5 text-[10px] font-bold rounded-md transition text-gray-400 hover:text-white">Host</button>
                     <button onclick="manualSetRole('client')" id="btn-role-client" class="flex-1 py-1.5 text-[10px] font-bold rounded-md transition text-gray-400 hover:text-white">Client</button>
                 </div>
            </div>

            <!-- My Identity Section -->
            <div class="glass p-4 rounded-xl relative group/edit">
                <div class="flex justify-between items-center mb-2">
                    <label class="text-xs uppercase font-bold text-gray-500">My Identity</label>
                    <button onclick="enableIdEdit()" class="text-xs text-blue-400 hover:text-white flex items-center gap-1">
                        <i class="fa-solid fa-pen"></i> Edit
                    </button>
                </div>
                
                <div class="flex items-center gap-2 bg-slate-900 p-2 rounded border border-gray-700 transition-colors focus-within:border-blue-500">
                    <input id="my-id-input" type="text" value="..." disabled 
                        class="bg-transparent text-blue-400 font-mono text-sm truncate flex-1 outline-none disabled:text-blue-400/80"
                        onblur="saveCustomId()" onkeydown="if(event.key === 'Enter') this.blur()">
                    
                    <button onclick="copyId()" class="text-gray-400 p-1 hover:text-white" title="Copy"><i class="fa-regular fa-copy"></i></button>
                </div>
                
                <div class="mt-3 text-center">
                    <button onclick="toggleQR()" class="text-xs text-gray-400 hover:text-white flex items-center justify-center gap-2 w-full py-2 border border-gray-700 rounded hover:bg-slate-800 transition">
                        <i class="fa-solid fa-qrcode"></i> Show/Hide QR
                    </button>
                    <div id="qr-container" class="hidden mt-3 bg-white p-2 rounded-lg inline-block shadow-lg">
                         <canvas id="qr-code" class="w-32 h-32"></canvas>
                    </div>
                </div>
            </div>

            <div class="flex-1">
                <div class="flex justify-between items-end mb-2">
                    <label class="text-xs uppercase font-bold text-gray-500">Nearby Devices</label>
                    <span id="discovery-status" class="text-[10px] text-green-400 animate-pulse">Scanning...</span>
                </div>
                <div id="peer-list" class="space-y-2">
                    <div class="text-center p-4 border border-dashed border-gray-700 rounded-lg text-gray-500 text-xs">
                        Searching... <br> (Check Room Code)
                    </div>
                </div>
            </div>

            <div class="glass p-4 rounded-xl">
                <label class="text-xs uppercase font-bold text-gray-500 block mb-2">Manual Connect</label>
                <div class="flex gap-2">
                    <input type="text" id="remote-id" placeholder="Enter ID" class="w-full bg-slate-900 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white focus:outline-none focus:border-blue-500">
                    <button onclick="initiateConnection(document.getElementById('remote-id').value)" class="bg-blue-600 text-white px-4 rounded-lg">
                        <i class="fa-solid fa-arrow-right"></i>
                    </button>
                </div>
            </div>
            <div id="status-log" class="text-xs font-mono text-gray-500 h-20 overflow-y-auto p-2 rounded bg-black/20"></div>
        </div>

        <!-- Right Panel: Files -->
        <div id="right-panel" class="w-full flex-1 bg-slate-900 relative flex flex-col h-full hidden md:flex min-h-0">
            
            <div id="drop-zone" class="absolute inset-0 bg-blue-600/10 z-50 hidden border-4 border-blue-500 border-dashed m-4 rounded-2xl flex items-center justify-center backdrop-blur-sm">
                <h2 class="text-2xl font-bold text-white">Drop to Send</h2>
            </div>

            <div id="waiting-screen" class="hidden absolute inset-0 bg-slate-900 z-40 flex flex-col items-center justify-center text-center p-6">
                <div class="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-4"></div>
                <h3 class="text-lg font-bold text-white">Waiting...</h3>
                <p class="text-gray-400 text-xs mt-2">Ask peer to accept connection.</p>
                <button onclick="cancelConnection()" class="mt-4 text-red-400 text-xs underline">Cancel</button>
            </div>

            <div id="empty-state" class="flex-1 flex flex-col items-center justify-center text-gray-600 p-6">
                <div class="w-20 h-20 bg-slate-800 rounded-full flex items-center justify-center mb-4 border border-gray-700">
                    <i class="fa-solid fa-satellite-dish text-2xl text-gray-500"></i>
                </div>
                <p class="text-sm">Select a device to start.</p>
            </div>

            <div id="file-list" class="flex-1 overflow-y-auto p-4 space-y-3 hidden no-scrollbar pb-24 md:pb-4"></div>

            <div class="p-4 bg-slate-800 border-t border-gray-700 hidden shrink-0" id="action-bar">
                <input type="file" id="file-input" class="hidden" onchange="handleFiles(this.files)">
                
                <button id="send-btn" onclick="triggerFileSelect()" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-4 rounded-xl font-bold shadow-lg flex items-center justify-center gap-2 active:scale-95 transition-transform">
                    <i class="fa-solid fa-paper-plane"></i> Send File
                </button>
                
                <div id="progress-container" class="hidden w-full flex items-center gap-3">
                    <div class="flex-1">
                        <div class="flex justify-between text-xs mb-1">
                            <span class="text-blue-400" id="progress-text">Sending...</span>
                            <span class="text-white" id="progress-percent">0%</span>
                        </div>
                        <div class="h-2 bg-gray-700 rounded-full overflow-hidden">
                            <div id="progress-bar" class="h-full bg-blue-500 w-0 transition-all duration-200"></div>
                        </div>
                    </div>
                    <button onclick="cancelTransfer()" class="w-10 h-10 rounded-full bg-red-500/20 text-red-400 flex items-center justify-center">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </div>
                <div class="h-14 md:hidden"></div>
            </div>
        </div>
    </div>

    <!-- Mobile Nav -->
    <div class="md:hidden fixed bottom-0 w-full bg-slate-900 border-t border-gray-800 flex h-16 z-50 shadow-2xl safe-area-pb">
        <button onclick="switchTab('conn')" id="tab-conn" class="flex-1 flex flex-col items-center justify-center tab-active">
            <i class="fa-solid fa-network-wired text-lg mb-1"></i>
            <span class="text-[10px] font-medium uppercase tracking-wide">Devices</span>
        </button>
        <button onclick="switchTab('files')" id="tab-files" class="flex-1 flex flex-col items-center justify-center tab-inactive relative">
            <i class="fa-solid fa-folder-open text-lg mb-1"></i>
            <span class="text-[10px] font-medium uppercase tracking-wide">Files</span>
            <div id="file-notify" class="hidden absolute top-3 right-1/3 w-2 h-2 bg-red-500 rounded-full animate-bounce"></div>
        </button>
    </div>

    <script>
        let peer, conn, discoveryConn;
        let myId = null;
        let isHost = false;
        let currentRoomHash = '';
        let discoveredPeers = [];
        let discoveryClients = []; 
        let activeTransfer = null;
        let connectionRequest = null;
        let manualRole = 'auto'; 
        
        const CHUNK_SIZE = 16 * 1024; 
        const BUFFER_THRESHOLD = 256 * 1024; 

        const els = {
            qrCanvas: document.getElementById('qr-code'),
            myId: document.getElementById('my-id-input'), 
            log: document.getElementById('status-log'),
            emptyState: document.getElementById('empty-state'),
            fileList: document.getElementById('file-list'),
            actionBar: document.getElementById('action-bar'),
            badge: document.getElementById('connection-badge'),
            roleBadge: document.getElementById('role-badge'),
            dropZone: document.getElementById('drop-zone'),
            progressBox: document.getElementById('progress-container'),
            progressBar: document.getElementById('progress-bar'),
            progressText: document.getElementById('progress-text'),
            progressPercent: document.getElementById('progress-percent'),
            sendBtn: document.getElementById('send-btn'),
            peerList: document.getElementById('peer-list'),
            discoveryStatus: document.getElementById('discovery-status'),
            requestModal: document.getElementById('request-modal'),
            requestIdDisplay: document.getElementById('request-id'),
            waitingScreen: document.getElementById('waiting-screen'),
            leftPanel: document.getElementById('left-panel'),
            rightPanel: document.getElementById('right-panel'),
            tabConn: document.getElementById('tab-conn'),
            tabFiles: document.getElementById('tab-files'),
            fileNotify: document.getElementById('file-notify'),
            qrContainer: document.getElementById('qr-container'),
            roomInput: document.getElementById('room-input')
        };

        function switchTab(tab) {
            if (tab === 'conn') {
                els.leftPanel.classList.remove('hidden');
                els.rightPanel.classList.add('hidden');
                els.tabConn.className = "flex-1 flex flex-col items-center justify-center tab-active";
                els.tabFiles.className = "flex-1 flex flex-col items-center justify-center tab-inactive";
            } else {
                els.leftPanel.classList.add('hidden');
                els.rightPanel.classList.remove('hidden');
                els.rightPanel.classList.add('flex');
                els.tabConn.className = "flex-1 flex flex-col items-center justify-center tab-inactive";
                els.tabFiles.className = "flex-1 flex flex-col items-center justify-center tab-active";
                els.fileNotify.classList.add('hidden');
            }
        }

        function triggerFileSelect() {
            if (!conn || !conn.open) {
                alert("⚠️ Not connected. Connect to a device first.");
                switchTab('conn');
                return;
            }
            document.getElementById('file-input').click();
        }

        function enableIdEdit() {
            els.myId.disabled = false;
            els.myId.focus();
            els.myId.select();
            els.myId.classList.add('text-white');
        }

        function saveCustomId() {
            const newId = els.myId.value.trim();
            els.myId.disabled = true;
            els.myId.classList.remove('text-white');
            if (newId && newId !== myId) {
                log(`Setting custom ID: ${newId}...`);
                if(peer) peer.destroy();
                initPeerWithId(newId);
            } else {
                els.myId.value = myId; 
            }
        }

        function applyRoomCode() {
            const newCode = els.roomInput.value.trim();
            if(newCode && newCode !== currentRoomHash) {
                currentRoomHash = newCode;
                log(`Joining room: ${newCode}`);
                manualSetRole(manualRole); // Re-init with new room
            }
        }

        window.addEventListener('load', async () => {
            try {
                const res = await fetch('https://api.ipify.org?format=json');
                const data = await res.json();
                // Simple hash: last part of IP to make it readable
                const parts = data.ip.split(/[\.:]/);
                currentRoomHash = parts[parts.length-1] + "-" + parts[parts.length-2];
                log("Detected Room: " + currentRoomHash);
            } catch (e) {
                log("IP detection failed. Using random.");
                currentRoomHash = Math.floor(Math.random()*9000 + 1000).toString();
            }
            els.roomInput.value = currentRoomHash;
            initPeer(currentRoomHash, 'auto');
            setupDragDrop();
        });

        function manualSetRole(role) {
            manualRole = role;
            ['auto', 'host', 'client'].forEach(r => {
                const btn = document.getElementById(`btn-role-${r}`);
                if (r === role) {
                    btn.classList.remove('text-gray-400', 'hover:text-white');
                    btn.classList.add('bg-blue-600', 'text-white');
                } else {
                    btn.classList.add('text-gray-400', 'hover:text-white');
                    btn.classList.remove('bg-blue-600', 'text-white');
                }
            });

            if(peer) peer.destroy();
            discoveredPeers = [];
            discoveryClients = [];
            updatePeerListUI();
            
            log(`Restarting as ${role}...`);
            initPeer(currentRoomHash, role);
        }

        function initPeerWithId(customId) {
            isHost = true; 
            createPeerInstance(customId);
        }

        function initPeer(roomHash, role) {
            const hostId = `wifidrop-host-${roomHash}`;
            let peerId = null;
            if (role === 'host') peerId = hostId;
            else if (role === 'client') peerId = null; 
            else peerId = hostId; 

            createPeerInstance(peerId, role === 'auto' ? hostId : null);
        }

        function createPeerInstance(id, fallbackHostId) {
            const options = {
                debug: 1, secure: true,
                config: { iceServers: [{ urls: 'stun:stun1.l.google.com:19302' }, { urls: 'stun:global.stun.twilio.com:3478' }] }
            };
            
            peer = id ? new Peer(id, options) : new Peer(options);

            peer.on('open', (id) => {
                myId = id;
                els.myId.value = id; 
                generateQR();
                
                if (id.startsWith('wifidrop-host-') || (id !== null && !id.startsWith('client-') && !id.startsWith('wifi-client-'))) {
                    isHost = true;
                    onPeerReady();
                    els.roleBadge.innerHTML = '<i class="fa-solid fa-crown text-yellow-400"></i><span>Host</span>';
                    discoveredPeers = [{ id: myId, label: 'Host (You)' }];
                    updatePeerListUI();
                } else {
                    isHost = false;
                    onPeerReady();
                    els.roleBadge.innerHTML = '<i class="fa-solid fa-user text-blue-400"></i><span>Client</span>';
                    if(fallbackHostId) connectToHost(fallbackHostId);
                }
            });

            peer.on('error', (err) => {
                if (err.type === 'unavailable-id') {
                    // This is expected logic in Auto mode, NOT an error
                    // log(`Host busy. Joining as client...`); // Optional log
                    peer.destroy(); 
                    isHost = false;
                    createPeerInstance(null, id); // 'id' here is the taken hostId
                } else if (err.type === 'peer-unavailable') {
                    if (!isHost && fallbackHostId) {
                        log("Host not found. Retrying in 3s...");
                        setTimeout(() => connectToHost(fallbackHostId), 3000);
                    }
                } else {
                    console.log(`Peer: ${err.type}`);
                }
            });

            peer.on('connection', handleIncomingConnection);
        }

        function onPeerReady() {
            generateQR();
            els.discoveryStatus.textContent = "Active";
            const urlParams = new URLSearchParams(window.location.search);
            const remotePeer = urlParams.get('peer');
            if (remotePeer && remotePeer !== myId) initiateConnection(remotePeer);
        }

        function connectToHost(hostId) {
            log("Scan: Connecting to Host...");
            discoveryConn = peer.connect(hostId, { label: 'discovery', reliable: true });
            
            discoveryConn.on('open', () => {
                log("Scan: Connected to Host.");
                // Explicitly send register to trigger list update on Host
                discoveryConn.send({ type: 'register', id: myId });
            });
            
            discoveryConn.on('data', (data) => {
                if (data.type === 'peer-list') {
                    discoveredPeers = data.peers;
                    updatePeerListUI();
                }
            });
        }

        function handleIncomingConnection(c) {
            // HOST LOGIC: Handle Discovery
            if (c.label === 'discovery' && isHost) {
                c.on('open', () => {
                    if (!discoveryClients.includes(c)) discoveryClients.push(c);
                });
                
                c.on('data', (data) => {
                    if (data.type === 'register') {
                        // Add peer on explicit register signal
                        if (!discoveredPeers.find(p => p.id === data.id)) {
                            discoveredPeers.push({ id: data.id, label: 'Device ' + data.id.substr(-4) });
                            broadcastPeerList();
                        }
                        // Send list back to this specific client
                        c.send({ type: 'peer-list', peers: discoveredPeers });
                    }
                });

                c.on('close', () => {
                    discoveredPeers = discoveredPeers.filter(p => p.id !== c.peer);
                    discoveryClients = discoveryClients.filter(conn => conn !== c);
                    broadcastPeerList();
                });
                return;
            }
            // CLIENT/HOST LOGIC: Handle File Transfer
            setupConnection(c);
        }

        function broadcastPeerList() {
            if (!isHost) return;
            const data = { type: 'peer-list', peers: discoveredPeers };
            discoveryClients.forEach(c => { if(c.open) c.send(data); });
        }

        function updatePeerListUI() {
            els.peerList.innerHTML = '';
            const list = discoveredPeers.filter(p => p.id !== myId);
            
            if (list.length === 0) {
                els.peerList.innerHTML = '<div class="text-center p-3 border border-dashed border-gray-700 rounded-lg text-gray-500 text-xs">Scanning...<br>(Check Room Code)</div>';
                return;
            }
            list.forEach(p => {
                const div = document.createElement('div');
                div.className = "flex items-center justify-between bg-slate-700/50 p-3 rounded-lg border border-gray-600/50";
                div.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-blue-900/50 flex items-center justify-center text-blue-400"><i class="fa-solid fa-mobile-screen"></i></div>
                        <div class="text-sm font-bold text-gray-200 truncate w-24">${p.id.substr(0,10)}..</div>
                    </div>
                    <button class="text-xs bg-blue-600 text-white px-3 py-1.5 rounded-md font-bold" onclick="initiateConnection('${p.id}')">Connect</button>
                `;
                els.peerList.appendChild(div);
            });
        }

        function initiateConnection(id) {
            if (!id || id === myId) return;
            if (window.innerWidth < 768) switchTab('files');
            els.waitingScreen.classList.remove('hidden');
            els.emptyState.classList.add('hidden');
            conn = peer.connect(id, { reliable: true });
            setupConnection(conn);
        }

        function setupConnection(c) {
            c.on('open', () => {
                if (c.peer === conn?.peer && els.waitingScreen.classList.contains('hidden') === false) {
                    c.send({ type: 'connection-request', from: myId });
                }
            });
            c.on('data', (data) => {
                if (data.type === 'connection-request') {
                    connectionRequest = { conn: c, id: data.from };
                    els.requestIdDisplay.textContent = data.from.substr(0,8) + "..";
                    els.requestModal.classList.remove('hidden');
                } else if (data.type === 'connection-accepted') {
                    connectionAuthorized(c);
                } else if (data.type === 'connection-rejected') {
                    alert("Connection denied.");
                    resetUI();
                } else {
                    handleIncomingData(data);
                }
            });
            c.on('close', () => { resetUI(); log('Disconnected'); });
            conn = c; 
        }

        function respondToRequest(accepted) {
            els.requestModal.classList.add('hidden');
            if (!connectionRequest) return;
            if (accepted) {
                connectionRequest.conn.send({ type: 'connection-accepted' });
                connectionAuthorized(connectionRequest.conn);
            } else {
                connectionRequest.conn.send({ type: 'connection-rejected' });
                connectionRequest.conn.close();
                connectionRequest = null;
            }
        }

        function connectionAuthorized(c) {
            conn = c;
            els.waitingScreen.classList.add('hidden');
            els.emptyState.classList.add('hidden');
            els.fileList.classList.remove('hidden');
            els.actionBar.classList.remove('hidden');
            els.badge.classList.remove('hidden');
            els.badge.innerHTML = '<div class="w-2 h-2 rounded-full bg-green-500"></div> Connected';
            if (window.innerWidth < 768) switchTab('files');
        }

        function cancelConnection() {
            if(conn) conn.close();
            resetUI();
        }

        async function handleFiles(files) {
            if (!files.length) return;
            if (activeTransfer) return alert("Transfer in progress.");
            if (!conn || !conn.open) return alert("Connection lost. Please reconnect.");

            const file = files[0];
            activeTransfer = { type: 'sender', cancelled: false };
            els.sendBtn.classList.add('hidden');
            els.progressBox.classList.remove('hidden');
            
            conn.send({ type: 'meta', name: file.name, size: file.size, mime: file.type });
            addFileBubble(file.name, file.size, 'sent', null);
            
            const reader = new FileReader();
            let offset = 0;
            const wait = ms => new Promise(res => setTimeout(res, ms));

            const readSlice = async () => {
                if (activeTransfer.cancelled) { resetTransferUI(); return; }
                if (conn.dataChannel.bufferedAmount > BUFFER_THRESHOLD) {
                    await wait(50);
                    readSlice();
                    return;
                }
                const slice = file.slice(offset, offset + CHUNK_SIZE);
                reader.readAsArrayBuffer(slice);
            };

            reader.onload = (e) => {
                if(!conn || !conn.open || activeTransfer.cancelled) return;
                try { conn.send(e.target.result); } catch(err) {
                    console.error("Send Error", err);
                    alert("Transfer failed.");
                    cancelTransfer();
                    return;
                }
                offset += e.target.result.byteLength;
                const pct = Math.round((offset / file.size) * 100);
                els.progressBar.style.width = pct + '%';
                els.progressPercent.textContent = pct + '%';
                if (offset < file.size) {
                    if (offset % (CHUNK_SIZE * 5) === 0) setTimeout(readSlice, 1);
                    else readSlice();
                } else {
                    resetTransferUI(); 
                    log('Sent successfully');
                }
            };
            readSlice();
        }

        let incoming = null;
        function handleIncomingData(data) {
            if (data.type === 'cancel') { resetTransferUI(); return; }
            if (data.type === 'meta') {
                activeTransfer = { type: 'receiver', cancelled: false };
                incoming = { name: data.name, size: data.size, mime: data.mime, buffer: [], received: 0 };
                els.sendBtn.classList.add('hidden');
                els.progressBox.classList.remove('hidden');
                els.progressText.textContent = `Rx: ${data.name.substr(0,10)}...`;
                if (window.innerWidth < 768) els.fileNotify.classList.remove('hidden');
                return;
            }
            if (incoming && (data instanceof ArrayBuffer || data instanceof Uint8Array)) {
                if(activeTransfer.cancelled) return;
                incoming.buffer.push(data);
                incoming.received += data.byteLength;
                const pct = Math.round((incoming.received / incoming.size) * 100);
                els.progressBar.style.width = pct + '%';
                els.progressPercent.textContent = pct + '%';
                if (incoming.received >= incoming.size) saveFile();
            }
        }
        function saveFile() {
            const blob = new Blob(incoming.buffer, { type: incoming.mime });
            const url = URL.createObjectURL(blob);
            addFileBubble(incoming.name, incoming.size, 'received', url);
            resetTransferUI();
            incoming = null;
        }
        function cancelTransfer() {
            if(!activeTransfer) return;
            activeTransfer.cancelled = true;
            conn.send({ type: 'cancel' }); 
            resetTransferUI();
        }
        function resetTransferUI() {
            activeTransfer = null;
            els.progressBox.classList.add('hidden');
            els.sendBtn.classList.remove('hidden');
            els.progressBar.style.width = '0%';
            document.getElementById('file-input').value = '';
        }

        function generateQR() {
            const baseUrl = window.location.href.split('?')[0];
            const url = `${baseUrl}?peer=${myId}`;
            new QRious({ element: els.qrCanvas, value: url, size: 200, backgroundAlpha: 0, foreground: '#0f172a' });
        }
        function toggleQR() { els.qrContainer.classList.toggle('hidden'); }
        function addFileBubble(name, size, type, url) {
            const isSent = type === 'sent';
            const div = document.createElement('div');
            div.className = `flex ${isSent ? 'justify-end' : 'justify-start'} animate-fade-in`;
            div.innerHTML = `
                <div class="${isSent ? 'bg-blue-600' : 'bg-slate-700'} p-3 rounded-2xl max-w-[85%] border border-white/5 shadow-lg">
                    <div class="flex items-center gap-3">
                        <div class="bg-black/20 p-2 rounded-lg shrink-0"><i class="fa-solid ${isSent ? 'fa-upload' : 'fa-download'} text-white"></i></div>
                        <div class="overflow-hidden min-w-0">
                            <p class="font-bold text-white text-xs truncate">${name}</p>
                            <p class="text-[10px] text-blue-200">${formatBytes(size)}</p>
                        </div>
                    </div>
                    ${url ? `<a href="${url}" download="${name}" class="mt-2 block w-full bg-white/10 hover:bg-white/20 text-center py-2 rounded text-xs font-bold text-white">Save File</a>` : ''}
                </div>`;
            els.fileList.appendChild(div);
            els.fileList.scrollTop = els.fileList.scrollHeight;
        }
        function resetUI() {
            conn = null;
            resetTransferUI();
            els.emptyState.classList.remove('hidden');
            els.fileList.classList.add('hidden');
            els.actionBar.classList.add('hidden');
            els.badge.classList.add('hidden');
            els.waitingScreen.classList.add('hidden');
            els.fileList.innerHTML = '';
        }
        function log(msg) { els.log.prepend(Object.assign(document.createElement('div'), { textContent: `> ${msg}` })); }
        function formatBytes(b) { if(!b) return '0B'; const k=1024, i=Math.floor(Math.log(b)/Math.log(k)); return parseFloat((b/Math.pow(k,i)).toFixed(1)) + ['B','KB','MB','GB'][i]; }
        function copyId() { navigator.clipboard.writeText(myId); alert("ID Copied"); }
        function copyLink() { navigator.clipboard.writeText(`${window.location.href.split('?')[0]}?peer=${myId}`); alert("Link copied!"); }
        function setupDragDrop() {
            window.addEventListener('dragenter', () => els.dropZone.classList.remove('hidden'));
            els.dropZone.addEventListener('dragleave', () => els.dropZone.classList.add('hidden'));
            els.dropZone.addEventListener('dragover', e => e.preventDefault());
            els.dropZone.addEventListener('drop', e => { e.preventDefault(); els.dropZone.classList.add('hidden'); handleFiles(e.dataTransfer.files); });
        }
    </script>
</body>
</html>
