<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WiFi Drop - Diagnostic</title>
    
    <!-- Styling & Icons -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Networking Libraries -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: system-ui, -apple-system, sans-serif; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.05); }
        .pulse-ring { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); } 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); } }
        /* Log styling */
        .log-entry { font-family: monospace; font-size: 10px; padding: 2px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .log-info { color: #60a5fa; }
        .log-success { color: #4ade80; }
        .log-error { color: #f87171; }
        .log-warn { color: #fbbf24; }
    </style>
</head>
<body class="h-[100dvh] flex flex-col overflow-hidden">

    <!-- Navbar -->
    <nav class="h-14 border-b border-gray-800 bg-slate-900 flex justify-between items-center px-4 shrink-0 z-20">
        <div class="flex items-center gap-2">
            <div class="w-8 h-8 rounded bg-blue-600 flex items-center justify-center text-white"><i class="fa-solid fa-wifi"></i></div>
            <h1 class="font-bold text-lg text-white">WiFi<span class="text-blue-500">Drop</span></h1>
        </div>
        <div id="status-badge" class="px-3 py-1 rounded-full text-[10px] font-bold bg-slate-800 border border-slate-700 text-slate-400 flex items-center gap-2">
            <div class="w-2 h-2 rounded-full bg-red-500" id="status-dot"></div>
            <span id="status-text">Disconnected</span>
        </div>
    </nav>

    <!-- Content Area -->
    <div class="flex-1 flex flex-col md:flex-row relative overflow-hidden">
        
        <!-- Left: Connectivity Panel -->
        <div class="w-full md:w-[350px] bg-slate-900 border-r border-gray-800 flex flex-col h-full z-10">
            <div class="p-4 space-y-4 flex-1 overflow-y-auto">
                
                <!-- Share Card -->
                <div class="glass p-5 rounded-2xl border border-gray-700">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xs font-bold text-gray-400 uppercase tracking-wider">My Device</h2>
                        <button onclick="toggleQR()" class="text-blue-400 hover:text-white text-xs"><i class="fa-solid fa-qrcode mr-1"></i>QR</button>
                    </div>

                    <div class="relative mb-3">
                        <input id="my-id" readonly class="w-full bg-slate-950 border border-gray-600 rounded-xl py-3 pl-3 pr-10 text-xs font-mono text-white outline-none focus:border-blue-500 transition-colors" value="Initializing...">
                        <button onclick="copyToClipboard(document.getElementById('my-id').value)" class="absolute right-2 top-2 p-1 text-gray-400 hover:text-white"><i class="fa-regular fa-copy"></i></button>
                    </div>

                    <div id="qr-area" class="hidden flex justify-center mb-4 bg-white p-2 rounded-xl">
                        <canvas id="qr-code"></canvas>
                    </div>

                    <button onclick="copyLink()" class="w-full py-3 bg-blue-600 hover:bg-blue-500 text-white rounded-xl font-bold text-sm shadow-lg shadow-blue-900/20 transition active:scale-95 flex items-center justify-center gap-2">
                        <i class="fa-solid fa-link"></i> Copy Magic Link
                    </button>
                </div>

                <!-- Connect Manual -->
                <div class="glass p-4 rounded-2xl border border-gray-700">
                    <label class="text-[10px] font-bold text-gray-500 uppercase block mb-2">Connect Manually</label>
                    <div class="flex gap-2">
                        <input id="remote-id" placeholder="Paste ID here" class="w-full bg-slate-950 border border-gray-600 rounded-xl px-3 py-2 text-xs text-white outline-none focus:border-blue-500">
                        <button onclick="connectToPeer()" class="bg-slate-700 hover:bg-slate-600 text-white w-10 rounded-xl flex items-center justify-center shadow-lg transition">
                            <i class="fa-solid fa-arrow-right"></i>
                        </button>
                    </div>
                </div>

                <!-- System Log -->
                <div class="flex-1 min-h-[150px] bg-black/30 rounded-xl border border-gray-800 p-3 overflow-hidden flex flex-col">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-[10px] font-bold text-gray-500 uppercase">System Log</span>
                        <button onclick="clearLog()" class="text-[10px] text-gray-600 hover:text-white">Clear</button>
                    </div>
                    <div id="system-log" class="flex-1 overflow-y-auto font-mono text-[10px] space-y-1">
                        <div class="log-info">> App started.</div>
                    </div>
                </div>

            </div>
        </div>

        <!-- Right: File Transfer Area -->
        <div class="flex-1 bg-slate-950 relative flex flex-col h-full min-h-0">
            
            <!-- Connection Overlay -->
            <div id="connect-overlay" class="absolute inset-0 bg-slate-950 z-20 flex flex-col items-center justify-center text-center p-6">
                <div class="w-20 h-20 bg-slate-900 rounded-3xl flex items-center justify-center mb-6 border border-slate-800 shadow-2xl pulse-ring">
                    <i class="fa-solid fa-satellite-dish text-3xl text-gray-600"></i>
                </div>
                <h3 class="text-xl font-bold text-white mb-2">Waiting for Connection</h3>
                <p class="text-gray-400 text-sm max-w-xs mb-6">Share the link or enter an ID to start.</p>
                <div class="flex gap-2">
                    <button onclick="testConnection()" class="px-4 py-2 bg-slate-800 hover:bg-slate-700 rounded-lg text-xs text-gray-300 border border-slate-700">Self-Test</button>
                    <button onclick="location.reload()" class="px-4 py-2 bg-slate-800 hover:bg-slate-700 rounded-lg text-xs text-gray-300 border border-slate-700">Reload</button>
                </div>
            </div>

            <!-- Drag Drop Zone -->
            <div id="drop-zone" class="absolute inset-0 bg-blue-600/10 z-30 hidden backdrop-blur-sm border-4 border-blue-500/50 border-dashed m-4 rounded-3xl flex items-center justify-center pointer-events-none">
                <h2 class="text-2xl font-bold text-white">Drop to Send</h2>
            </div>

            <!-- Chat/File List -->
            <div id="file-list" class="flex-1 overflow-y-auto p-4 md:p-8 space-y-4 pb-24"></div>

            <!-- Action Bar -->
            <div class="p-4 bg-slate-900/90 backdrop-blur border-t border-gray-800 z-10">
                <input type="file" id="file-input" class="hidden" onchange="sendFile(this.files[0])">
                
                <div class="max-w-3xl mx-auto">
                    <button onclick="document.getElementById('file-input').click()" id="send-btn" disabled class="w-full bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-500 hover:to-cyan-500 text-white py-3.5 rounded-xl font-bold shadow-lg shadow-blue-900/20 flex items-center justify-center gap-2 active:scale-95 transition-all disabled:opacity-50 disabled:cursor-not-allowed disabled:shadow-none disabled:bg-slate-800">
                        <i class="fa-solid fa-paper-plane"></i> Send File
                    </button>
                    
                    <!-- Progress Bar -->
                    <div id="progress-container" class="hidden mt-3 bg-slate-800 p-3 rounded-xl border border-gray-700">
                        <div class="flex justify-between text-[10px] mb-1.5 font-bold uppercase tracking-wider text-blue-400">
                            <span>Transferring...</span>
                            <span id="progress-pct">0%</span>
                        </div>
                        <div class="h-1.5 bg-slate-950 rounded-full overflow-hidden">
                            <div id="progress-bar" class="h-full bg-blue-500 w-0 transition-all duration-100"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="toast" class="fixed top-4 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-4 py-2 rounded-full shadow-2xl border border-gray-700 text-xs font-bold flex items-center gap-2 opacity-0 pointer-events-none transition-opacity z-50 transform translate-y-[-10px]">
        <i class="fa-solid fa-info-circle text-blue-400"></i> <span id="toast-msg">Notification</span>
    </div>

    <script>
        const CHUNK_SIZE = 64 * 1024; 
        let peer, conn, myId;
        
        const els = {
            myId: document.getElementById('my-id'),
            remoteId: document.getElementById('remote-id'),
            statusDot: document.getElementById('status-dot'),
            statusText: document.getElementById('status-text'),
            overlay: document.getElementById('connect-overlay'),
            fileList: document.getElementById('file-list'),
            sendBtn: document.getElementById('send-btn'),
            progressContainer: document.getElementById('progress-container'),
            progressBar: document.getElementById('progress-bar'),
            progressPct: document.getElementById('progress-pct'),
            toast: document.getElementById('toast'),
            toastMsg: document.getElementById('toast-msg'),
            log: document.getElementById('system-log')
        };

        function addLog(msg, type='info') {
            const div = document.createElement('div');
            div.className = `log-entry log-${type}`;
            div.textContent = `> ${msg}`;
            els.log.appendChild(div);
            els.log.scrollTop = els.log.scrollHeight;
        }

        function clearLog() {
            els.log.innerHTML = '';
        }

        window.addEventListener('load', () => {
            initPeer();
            
            // Auto Connect
            const urlParams = new URLSearchParams(window.location.search);
            const targetPeer = urlParams.get('connect');
            if(targetPeer) {
                document.getElementById('remote-id').value = targetPeer;
                addLog(`Auto-connect found ID: ${targetPeer}`, 'warn');
                // Wait for peer ready
                const checkReady = setInterval(() => {
                    if (peer && !peer.disconnected && !peer.destroyed && myId) {
                        clearInterval(checkReady);
                        connectToPeer();
                    }
                }, 500);
            }

            setupDragDrop();
        });

        function initPeer() {
            addLog("Initializing Peer...", 'info');
            
            // Random ID
            const randomId = Math.random().toString(36).substr(2, 5);
            
            peer = new Peer(randomId, {
                debug: 1,
                config: {
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:global.stun.twilio.com:3478' }
                    ]
                }
            });

            peer.on('open', id => {
                myId = id;
                els.myId.value = id;
                updateStatus('online');
                generateQR(id);
                addLog(`Peer Created. ID: ${id}`, 'success');
            });

            peer.on('connection', c => {
                addLog(`Incoming connection from ${c.peer}`, 'warn');
                conn = c;
                setupConnection();
            });

            peer.on('error', err => {
                console.error(err);
                addLog(`Peer Error: ${err.type}`, 'error');
                showToast("Error: " + err.type);
                if(err.type === 'peer-unavailable') {
                    addLog("Target device not found. Check ID.", 'error');
                }
            });
            
            peer.on('disconnected', () => {
                updateStatus('offline');
                addLog("Disconnected from server.", 'error');
                setTimeout(() => { 
                    if(peer && !peer.destroyed) {
                        addLog("Reconnecting...", 'warn');
                        peer.reconnect(); 
                    }
                }, 3000);
            });
        }

        function connectToPeer() {
            const targetId = els.remoteId.value.trim();
            if(!targetId) return showToast("Enter an ID");
            if(targetId === myId) return showToast("Cannot connect to self");

            addLog(`Attempting connect to ${targetId}...`, 'info');
            
            // Explicitly use reliable: true and json serialization
            conn = peer.connect(targetId, { 
                reliable: true,
                serialization: 'json'
            });
            
            setupConnection();
        }

        function setupConnection() {
            // Connection Monitor
            const connTimer = setTimeout(() => {
                if(!conn.open) {
                    addLog("Connection timeout. Firewall blocked?", 'error');
                }
            }, 5000);

            conn.on('open', () => {
                clearTimeout(connTimer);
                updateStatus('connected');
                els.overlay.classList.add('hidden');
                els.sendBtn.disabled = false;
                addLog(`Connected to ${conn.peer}`, 'success');
                showToast("Connected Successfully!");
                
                // Clear URL param
                window.history.replaceState({}, document.title, window.location.pathname);
            });

            conn.on('data', handleData);

            conn.on('close', () => {
                updateStatus('online');
                els.overlay.classList.remove('hidden');
                els.sendBtn.disabled = true;
                addLog("Partner disconnected", 'error');
                showToast("Connection Lost");
            });
            
            conn.on('error', (err) => {
                addLog(`Connection Error: ${err}`, 'error');
            });
        }

        function sendFile(file) {
            if(!conn || !conn.open) return showToast("Not Connected");
            if(!file) return;

            addLog(`Sending ${file.name}...`, 'info');
            conn.send({ type: 'meta', name: file.name, size: file.size, mime: file.type });
            
            addFileBubble('sent', file.name, file.size);
            els.progressContainer.classList.remove('hidden');

            const reader = new FileReader();
            let offset = 0;

            reader.onload = (e) => {
                conn.send({ type: 'chunk', data: e.target.result });
                offset += e.target.result.byteLength;
                
                const pct = Math.round((offset / file.size) * 100);
                els.progressBar.style.width = pct + '%';
                els.progressPct.textContent = pct + '%';

                if (offset < file.size) {
                    readSlice(offset);
                } else {
                    els.progressContainer.classList.add('hidden');
                    addLog("File sent successfully", 'success');
                    showToast("Sent Successfully");
                }
            };

            const readSlice = (o) => {
                const slice = file.slice(o, o + CHUNK_SIZE);
                reader.readAsArrayBuffer(slice);
            };

            readSlice(0);
        }

        let incoming = null;
        function handleData(data) {
            if(data.type === 'meta') {
                incoming = {
                    name: data.name,
                    size: data.size,
                    mime: data.mime,
                    buffer: [],
                    received: 0
                };
                els.progressContainer.classList.remove('hidden');
                els.progressPct.textContent = "Receiving...";
                addLog(`Receiving ${data.name}...`, 'info');
                return;
            }

            if(data.type === 'chunk' && incoming) {
                incoming.buffer.push(data.data);
                incoming.received += data.data.byteLength;
                
                const pct = Math.round((incoming.received / incoming.size) * 100);
                els.progressBar.style.width = pct + '%';
                els.progressPct.textContent = pct + '%';

                if(incoming.received >= incoming.size) {
                    const blob = new Blob(incoming.buffer, { type: incoming.mime });
                    const url = URL.createObjectURL(blob);
                    
                    addFileBubble('received', incoming.name, incoming.size, url);
                    
                    els.progressContainer.classList.add('hidden');
                    incoming = null;
                    addLog("File received successfully", 'success');
                    showToast("File Received");
                }
            }
        }

        function updateStatus(state) {
            if(state === 'online') {
                els.statusDot.className = "w-2 h-2 rounded-full bg-yellow-500";
                document.getElementById('status-text').textContent = "Ready";
            } else if (state === 'connected') {
                els.statusDot.className = "w-2 h-2 rounded-full bg-green-500 shadow-[0_0_10px_#22c55e]";
                document.getElementById('status-text').textContent = "Connected";
            } else {
                els.statusDot.className = "w-2 h-2 rounded-full bg-red-500";
                document.getElementById('status-text').textContent = "Offline";
            }
        }

        function addFileBubble(type, name, size, url = null) {
            const div = document.createElement('div');
            const isSent = type === 'sent';
            
            div.className = `flex ${isSent ? 'justify-end' : 'justify-start'} fade-in`;
            div.innerHTML = `
                <div class="${isSent ? 'bg-blue-600' : 'bg-slate-700'} p-4 rounded-2xl max-w-[85%] border border-white/5 shadow-lg">
                    <div class="flex items-center gap-3">
                        <div class="bg-black/20 w-10 h-10 flex items-center justify-center rounded-xl shrink-0 text-white">
                            <i class="fa-solid ${isSent ? 'fa-arrow-up' : 'fa-arrow-down'}"></i>
                        </div>
                        <div class="overflow-hidden min-w-0">
                            <p class="font-bold text-white text-sm truncate">${name}</p>
                            <p class="text-[10px] text-blue-200 mt-0.5">${formatBytes(size)}</p>
                        </div>
                    </div>
                    ${url ? `<a href="${url}" download="${name}" class="mt-3 block w-full bg-white/10 hover:bg-white/20 text-center py-2.5 rounded-xl text-xs font-bold text-white transition">Download</a>` : ''}
                </div>`;
            els.fileList.appendChild(div);
            els.fileList.scrollTop = els.fileList.scrollHeight;
        }

        function copyLink() {
            const link = `${window.location.protocol}//${window.location.host}${window.location.pathname}?connect=${myId}`;
            copyToClipboard(link);
            showToast("Magic Link Copied!");
        }

        function copyToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.left = "-9999px";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy');
                addLog("Copied to clipboard", 'success');
            } catch (err) {
                console.error('Fallback: Oops, unable to copy', err);
            }
            document.body.removeChild(textArea);
        }

        function generateQR(id) {
            const link = `${window.location.protocol}//${window.location.host}${window.location.pathname}?connect=${id}`;
            new QRious({ element: document.getElementById('qr-code'), value: link, size: 200 });
        }

        function toggleQR() {
            document.getElementById('qr-area').classList.toggle('hidden');
        }

        function showToast(msg) {
            els.toastMsg.textContent = msg;
            els.toast.style.opacity = '1';
            els.toast.style.transform = 'translate(-50%, 0)';
            setTimeout(() => {
                els.toast.style.opacity = '0';
                els.toast.style.transform = 'translate(-50%, -20px)';
            }, 3000);
        }

        function formatBytes(b) { if(!b) return '0B'; const k=1024, i=Math.floor(Math.log(b)/Math.log(k)); return parseFloat((b/Math.pow(k,i)).toFixed(1)) + ['B','KB','MB','GB'][i]; }

        function setupDragDrop() {
            const dz = document.getElementById('drop-zone');
            window.addEventListener('dragenter', () => dz.classList.remove('hidden'));
            dz.addEventListener('dragleave', () => dz.classList.add('hidden'));
            dz.addEventListener('dragover', e => e.preventDefault());
            dz.addEventListener('drop', e => { 
                e.preventDefault(); 
                dz.classList.add('hidden'); 
                sendFile(e.dataTransfer.files[0]); 
            });
        }

        function testConnection() {
            window.open(`${window.location.protocol}//${window.location.host}${window.location.pathname}?connect=${myId}`, '_blank');
        }
    </script>
</body>
</html>
