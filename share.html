<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WiFi Drop - Auto Discovery</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: sans-serif; touch-action: manipulation; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .tab-active { color: #60a5fa; background: rgba(51, 65, 85, 0.5); border-top: 2px solid #60a5fa; }
        .tab-inactive { color: #94a3b8; border-top: 2px solid transparent; }
        .modal-enter { animation: modalIn 0.2s ease-out forwards; }
        @keyframes modalIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .toast-enter { animation: slideIn 0.3s ease-out forwards; }
        .toast-exit { animation: slideOut 0.3s ease-in forwards; }
        @keyframes slideIn { from { opacity: 0; transform: translate(-50%, -20px); } to { opacity: 1; transform: translate(-50%, 0); } }
        @keyframes slideOut { from { opacity: 1; transform: translate(-50%, 0); } to { opacity: 0; transform: translate(-50%, -20px); } }
    </style>
</head>
<body class="h-[100dvh] flex flex-col overflow-hidden bg-slate-900">

    <div id="toast-container" class="fixed top-4 left-1/2 z-[150] flex flex-col gap-2 w-max max-w-[90%] pointer-events-none transform -translate-x-1/2"></div>

    <div id="request-modal" class="fixed inset-0 bg-black/90 z-[100] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-slate-800 border border-gray-600 rounded-2xl p-6 max-w-sm w-full shadow-2xl modal-enter text-center">
            <h3 class="text-xl font-bold text-white mb-2">Connect Request</h3>
            <p class="text-gray-400 text-sm mb-6"><span id="request-id" class="font-mono text-white bg-slate-700 px-1 rounded">Device</span> wants to connect.</p>
            <div class="flex gap-3">
                <button onclick="respondToRequest(false)" class="flex-1 py-2.5 rounded-xl border border-slate-600 text-slate-300">Decline</button>
                <button onclick="respondToRequest(true)" class="flex-1 py-2.5 rounded-xl bg-blue-600 text-white font-bold">Accept</button>
            </div>
        </div>
    </div>

    <nav class="h-16 border-b border-gray-800 bg-slate-900/95 flex justify-between items-center px-4 shrink-0">
        <div class="flex items-center gap-2">
            <div class="w-8 h-8 rounded bg-blue-600 flex items-center justify-center"><i class="fa-solid fa-wifi text-white"></i></div>
            <h1 class="font-bold text-lg text-white">WiFi<span class="text-blue-500">Drop</span> <span class="text-[10px] text-gray-500">AUTO</span></h1>
        </div>
        <div id="status-pill" class="px-3 py-1 rounded-full text-[10px] font-bold bg-slate-800 border border-slate-700 text-slate-400 flex items-center gap-2">
            <div class="w-2 h-2 rounded-full bg-slate-500"></div><span id="status-text">Init...</span>
        </div>
    </nav>

    <div class="flex-1 flex flex-col md:flex-row relative overflow-hidden min-h-0">
        <div id="left-panel" class="w-full md:w-[340px] bg-slate-900 border-r border-gray-800 flex flex-col h-full overflow-y-auto pb-20 md:pb-0">
            <div class="p-4 space-y-4">
                <!-- Room Settings -->
                <div class="glass p-4 rounded-2xl border border-gray-800 bg-slate-800/30">
                    <div class="flex justify-between items-center mb-2"><span class="text-xs font-bold text-gray-500 uppercase">Room Code</span></div>
                    <div class="flex gap-2 mb-3">
                        <input type="text" id="room-input" class="w-full bg-slate-900 border border-gray-700 rounded-lg px-3 py-2 text-xs text-white" placeholder="Room">
                        <button onclick="applyRoomCode()" class="bg-slate-700 text-white px-3 rounded-lg text-xs font-bold">Set</button>
                    </div>
                    <div class="flex bg-slate-900 p-1 rounded-lg border border-gray-700">
                        <button onclick="manualSetRole('auto')" id="btn-role-auto" class="flex-1 py-1.5 text-[10px] font-bold rounded bg-blue-600 text-white">Auto</button>
                        <button onclick="manualSetRole('host')" id="btn-role-host" class="flex-1 py-1.5 text-[10px] font-bold rounded text-gray-400">Host</button>
                        <button onclick="manualSetRole('client')" id="btn-role-client" class="flex-1 py-1.5 text-[10px] font-bold rounded text-gray-400">Client</button>
                    </div>
                </div>

                <!-- My ID -->
                <div class="glass p-4 rounded-2xl border border-gray-800 bg-slate-800/30">
                    <label class="text-xs font-bold text-gray-500 uppercase block mb-2">My ID</label>
                    <div class="flex gap-2 mb-2">
                        <input id="my-id-input" type="text" disabled class="w-full bg-slate-900 border border-gray-700 rounded-lg px-3 py-2 text-xs text-white">
                        <button onclick="copyId()" class="text-gray-400 hover:text-white"><i class="fa-regular fa-copy"></i></button>
                    </div>
                    <div id="qr-container" class="hidden bg-white p-2 rounded-lg mx-auto w-max"><canvas id="qr-code" class="w-24 h-24"></canvas></div>
                    <button onclick="toggleQR()" class="text-[10px] text-blue-400 w-full text-center mt-1">Show QR</button>
                </div>

                <!-- Discovery List -->
                <div class="flex-1">
                    <div class="flex justify-between items-center mb-2 px-1">
                        <span class="text-xs font-bold text-gray-500 uppercase">Nearby</span>
                        <button onclick="refreshDiscovery()" class="text-[10px] text-blue-400"><i class="fa-solid fa-rotate-right"></i></button>
                    </div>
                    <div id="peer-list" class="space-y-2">
                        <div class="text-center py-4 border border-dashed border-gray-800 rounded-lg text-gray-600 text-xs">Scanning...</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="right-panel" class="w-full flex-1 bg-slate-950 relative flex flex-col h-full hidden md:flex min-h-0">
            <div id="drop-zone" class="absolute inset-0 bg-blue-600/20 z-50 hidden backdrop-blur-sm flex items-center justify-center border-4 border-blue-500 border-dashed m-6 rounded-3xl"><h2 class="text-2xl font-bold text-white">Drop to Send</h2></div>
            
            <div id="empty-state" class="flex-1 flex flex-col items-center justify-center text-gray-500">
                <i class="fa-regular fa-paper-plane text-4xl mb-4 opacity-50"></i>
                <p>Select a device to connect</p>
            </div>
            
            <div id="file-list" class="flex-1 overflow-y-auto p-4 space-y-3 hidden"></div>
            
            <div id="action-bar" class="p-4 bg-slate-900 border-t border-gray-800 hidden">
                <input type="file" id="file-input" class="hidden" onchange="handleFiles(this.files)">
                <button onclick="document.getElementById('file-input').click()" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold shadow-lg">Send File</button>
            </div>
        </div>
    </div>

    <!-- Mobile Nav -->
    <div class="md:hidden fixed bottom-0 w-full bg-slate-900/95 backdrop-blur-lg border-t border-gray-800 flex h-16 z-50">
        <button onclick="switchTab('conn')" id="tab-conn" class="flex-1 flex flex-col items-center justify-center tab-active"><i class="fa-solid fa-radar mb-1"></i><span class="text-[10px]">Devices</span></button>
        <button onclick="switchTab('files')" id="tab-files" class="flex-1 flex flex-col items-center justify-center tab-inactive"><i class="fa-solid fa-file-export mb-1"></i><span class="text-[10px]">Transfer</span></button>
    </div>

    <script>
        const CHUNK_SIZE = 64 * 1024;
        let peer, conn, discoveryConn, myId, isHost = false, currentRoomHash = 'default', discoveredPeers = [], discoveryClients = [], activeTransfer = null, connectionRequest = null;
        
        const els = {
            peerList: document.getElementById('peer-list'),
            fileList: document.getElementById('file-list'),
            emptyState: document.getElementById('empty-state'),
            actionBar: document.getElementById('action-bar'),
            leftPanel: document.getElementById('left-panel'),
            rightPanel: document.getElementById('right-panel'),
            roomInput: document.getElementById('room-input'),
            myIdInput: document.getElementById('my-id-input'),
            statusPill: document.getElementById('status-pill'),
            statusText: document.getElementById('status-text'),
            modal: document.getElementById('request-modal'),
            reqId: document.getElementById('request-id'),
            dropZone: document.getElementById('drop-zone')
        };

        function showToast(msg, type='info') {
            const t = document.createElement('div');
            t.className = `px-4 py-2 rounded-lg shadow-lg text-xs font-bold text-white mb-2 toast-enter transform -translate-x-1/2 ${type==='error'?'bg-red-500':'bg-slate-700'}`;
            t.textContent = msg;
            document.getElementById('toast-container').appendChild(t);
            setTimeout(() => { t.remove(); }, 3000);
        }

        function switchTab(t) {
            if(t === 'conn') { els.leftPanel.classList.remove('hidden'); els.rightPanel.classList.add('hidden'); }
            else { els.leftPanel.classList.add('hidden'); els.rightPanel.classList.remove('hidden'); els.rightPanel.classList.add('flex'); }
        }

        function updateStatus(txt, col) {
            els.statusText.textContent = txt;
            els.statusPill.querySelector('div').className = `w-2 h-2 rounded-full ${col==='green'?'bg-green-500':'bg-slate-500'}`;
        }

        window.onload = async () => {
            try {
                const res = await fetch('https://api.ipify.org?format=json');
                const data = await res.json();
                const p = data.ip.split('.');
                currentRoomHash = p[p.length-1]+'-'+p[p.length-2];
            } catch(e) { currentRoomHash = Math.floor(Math.random()*9999).toString(); }
            els.roomInput.value = currentRoomHash;
            initPeer(currentRoomHash, 'auto');
            
            window.ondragenter = () => els.dropZone.classList.remove('hidden');
            els.dropZone.ondragleave = () => els.dropZone.classList.add('hidden');
            els.dropZone.ondrop = (e) => { e.preventDefault(); els.dropZone.classList.add('hidden'); handleFiles(e.dataTransfer.files); };
            els.dropZone.ondragover = e => e.preventDefault();
        };

        function manualSetRole(role) {
            ['auto','host','client'].forEach(r => document.getElementById(`btn-role-${r}`).className = `flex-1 py-1.5 text-[10px] font-bold rounded ${r===role?'bg-blue-600 text-white':'text-gray-400'}`);
            if(peer) peer.destroy();
            discoveredPeers = []; discoveryClients = []; updateList();
            initPeer(currentRoomHash, role);
        }

        function applyRoomCode() {
            currentRoomHash = els.roomInput.value;
            manualSetRole('auto');
        }

        function refreshDiscovery() {
            if(!isHost) connectToHost(`wifidrop-host-${currentRoomHash}`);
            else broadcast();
        }

        function initPeer(room, role) {
            const hostId = `wifidrop-host-${room}`;
            let id = role === 'host' ? hostId : (role === 'client' ? null : hostId);
            
            peer = id ? new Peer(id) : new Peer();
            
            peer.on('open', (pid) => {
                myId = pid;
                els.myIdInput.value = pid;
                new QRious({element:document.getElementById('qr-code'), value:pid, size:100});
                
                if(pid === hostId) {
                    isHost = true;
                    updateStatus("Host Mode", "green");
                    discoveredPeers = [{id: myId, label: 'Host (You)'}];
                    updateList();
                } else {
                    isHost = false;
                    updateStatus("Client Mode", "green");
                    connectToHost(hostId);
                }
            });

            peer.on('error', (err) => {
                if(err.type === 'unavailable-id') {
                    if(role === 'host') return showToast("Host ID taken", "error");
                    isHost = false;
                    peer.destroy();
                    // Fallback to random client ID
                    setTimeout(() => {
                        peer = new Peer();
                        peer.on('open', (pid) => {
                            myId = pid; els.myIdInput.value = pid;
                            updateStatus("Client Mode", "green");
                            connectToHost(hostId);
                            // Re-attach conn listener
                            peer.on('connection', handleIncoming);
                        });
                        peer.on('connection', handleIncoming);
                    }, 200);
                }
            });
            
            peer.on('connection', handleIncoming);
        }

        function connectToHost(hid) {
            updateStatus("Scanning...", "yellow");
            discoveryConn = peer.connect(hid, {label:'discovery'});
            setTimeout(() => { if(discoveryConn.open) discoveryConn.send({type:'register', id:myId}); }, 1000);
            discoveryConn.on('open', () => { updateStatus("Connected to Host", "green"); discoveryConn.send({type:'register', id:myId}); });
            discoveryConn.on('data', d => { if(d.type==='list') { discoveredPeers=d.peers; updateList(); }});
        }

        function handleIncoming(c) {
            if(c.label === 'discovery' && isHost) {
                c.on('open', () => {
                    if(!discoveryClients.includes(c)) discoveryClients.push(c);
                });
                c.on('data', d => {
                    if(d.type === 'register') {
                        if(!discoveredPeers.find(p=>p.id===d.id)) discoveredPeers.push({id:d.id});
                        c.send({type:'list', peers:discoveredPeers});
                        broadcast();
                    }
                });
                c.on('close', () => {
                    discoveredPeers = discoveredPeers.filter(p=>p.id!==c.peer);
                    broadcast();
                });
                return;
            }
            setupConn(c);
        }

        function broadcast() {
            if(!isHost) return;
            discoveryClients.forEach(c => { if(c.open) c.send({type:'list', peers:discoveredPeers}); });
            updateList();
        }

        function updateList() {
            els.peerList.innerHTML = '';
            const list = discoveredPeers.filter(p => p.id !== myId);
            if(list.length === 0) els.peerList.innerHTML = '<div class="text-center py-4 border border-dashed border-gray-700 rounded text-gray-500 text-xs">Scanning...</div>';
            
            list.forEach(p => {
                const d = document.createElement('div');
                d.className = "flex justify-between items-center bg-slate-800 p-3 rounded-lg border border-gray-700";
                d.innerHTML = `<div class="text-xs font-bold text-gray-300 truncate w-32">${p.id}</div><button class="bg-blue-600 text-white px-3 py-1 rounded text-xs" onclick="connect('${p.id}')">Connect</button>`;
                els.peerList.appendChild(d);
            });
        }

        window.connect = (id) => {
            if(conn) conn.close();
            conn = peer.connect(id);
            setupConn(conn);
            showToast("Requesting...", "info");
        };

        function setupConn(c) {
            c.on('open', () => {
                if(c.peer === conn?.peer) c.send({type:'req', from:myId});
            });
            c.on('data', d => {
                if(d.type==='req') {
                    connectionRequest={conn:c, id:d.from};
                    els.reqId.textContent = d.from;
                    els.modal.classList.remove('hidden');
                } else if(d.type==='accept') {
                    conn=c;
                    els.emptyState.classList.add('hidden');
                    els.fileList.classList.remove('hidden');
                    els.actionBar.classList.remove('hidden');
                    showToast("Connected!", "success");
                    if(window.innerWidth < 768) switchTab('files');
                } else if (d.file) { // Simple Data
                     const blob = new Blob([d.file], {type: d.mime});
                     const url = URL.createObjectURL(blob);
                     const item = document.createElement('div');
                     item.innerHTML = `<div class="bg-slate-800 p-3 rounded-lg border border-slate-700 mb-2"><p class="text-xs text-white mb-1 font-bold">${d.name}</p><a href="${url}" download="${d.name}" class="text-blue-400 text-xs">Download</a></div>`;
                     els.fileList.appendChild(item);
                }
            });
            c.on('close', () => { els.emptyState.classList.remove('hidden'); els.fileList.classList.add('hidden'); els.actionBar.classList.add('hidden'); showToast("Disconnected", "error"); });
            conn=c;
        }

        window.respondToRequest = (acc) => {
            els.modal.classList.add('hidden');
            if(acc) {
                connectionRequest.conn.send({type:'accept'});
                conn = connectionRequest.conn;
                els.emptyState.classList.add('hidden');
                els.fileList.classList.remove('hidden');
                els.actionBar.classList.remove('hidden');
                if(window.innerWidth < 768) switchTab('files');
            } else {
                connectionRequest.conn.close();
            }
        };

        window.handleFiles = (files) => {
            if(!conn || !conn.open) return showToast("Not connected", "error");
            const f = files[0];
            conn.send({file: f, name: f.name, mime: f.type});
            const item = document.createElement('div');
            item.innerHTML = `<div class="bg-blue-900/20 p-3 rounded-lg border border-blue-500/30 mb-2 text-right"><p class="text-xs text-white mb-1 font-bold">${f.name}</p><span class="text-green-400 text-xs">Sent</span></div>`;
            els.fileList.appendChild(item);
        };

        window.toggleQR = () => document.getElementById('qr-container').classList.toggle('hidden');
        window.copyId = () => { navigator.clipboard.writeText(myId); showToast("Copied"); };
    </script>
</body>
</html>
