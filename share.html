<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WiFi Drop - Local File Share</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- PeerJS (Networking) -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    
    <!-- QRious (QR Code Generator) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Segoe UI', system-ui, sans-serif; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .pulse-ring { animation: pulse-ring 2s cubic-bezier(0.215, 0.61, 0.355, 1) infinite; }
        @keyframes pulse-ring {
            0% { transform: scale(0.33); opacity: 1; }
            80%, 100% { transform: scale(1.5); opacity: 0; }
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- Navbar -->
    <nav class="p-4 border-b border-gray-700 bg-slate-900/90 flex justify-between items-center z-10">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 rounded bg-blue-600 flex items-center justify-center">
                <i class="fa-solid fa-wifi text-white"></i>
            </div>
            <h1 class="font-bold text-xl tracking-tight">WiFi<span class="text-blue-500">Drop</span></h1>
        </div>
        
        <div id="connection-badge" class="hidden px-3 py-1 rounded-full text-xs font-bold bg-gray-800 text-gray-400 border border-gray-700 flex items-center gap-2">
            <div class="w-2 h-2 rounded-full bg-gray-500"></div>
            <span>Waiting...</span>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col md:flex-row relative">
        
        <!-- Left Panel: Identity & Connection -->
        <div class="md:w-1/3 lg:w-1/4 p-6 bg-slate-800 border-r border-gray-700 flex flex-col gap-6 overflow-y-auto">
            
            <!-- Instructions for Hosted Mode -->
            <div id="host-instructions" class="hidden bg-blue-500/10 border border-blue-500/30 p-3 rounded-lg text-blue-200 text-xs">
                <p class="font-bold mb-1"><i class="fa-solid fa-earth-americas mr-1"></i> You are Online</p>
                To connect, send the link below to your other device.
            </div>

            <!-- QR Code Section -->
            <div class="text-center" id="qr-container">
                <div class="bg-white p-4 rounded-xl shadow-lg inline-block mx-auto mb-4 relative group">
                    <canvas id="qr-code"></canvas>
                    <div class="absolute inset-0 flex items-center justify-center bg-black/80 text-white text-xs opacity-0 group-hover:opacity-100 transition rounded-xl cursor-pointer" onclick="copyLink()">
                        Click to Copy Link
                    </div>
                </div>
                <p class="text-sm text-gray-400 mb-2">Scan or share link to connect</p>
            </div>

            <!-- Manual ID Info -->
            <div class="glass p-4 rounded-xl">
                <label class="text-xs uppercase font-bold text-gray-500 block mb-2">My Device ID</label>
                <div class="flex items-center gap-2 bg-slate-900 p-2 rounded border border-gray-700">
                    <code id="my-id" class="text-blue-400 font-mono text-sm truncate flex-1">Generating...</code>
                    <button onclick="copyId()" class="text-gray-400 hover:text-white transition-colors" title="Copy ID"><i class="fa-regular fa-copy"></i></button>
                </div>
                <button onclick="copyLink()" class="mt-2 w-full bg-slate-700 hover:bg-slate-600 text-white text-xs py-2 rounded transition border border-gray-600">
                    <i class="fa-solid fa-share-nodes mr-1"></i> Copy Shareable Link
                </button>
            </div>

            <!-- Manual Connect -->
            <div class="glass p-4 rounded-xl" id="manual-connect-box">
                <label class="text-xs uppercase font-bold text-gray-500 block mb-2">Connect Manually</label>
                <div class="flex gap-2">
                    <input type="text" id="remote-id" placeholder="Paste Peer ID here" class="w-full bg-slate-900 border border-gray-700 rounded px-3 py-2 text-sm focus:outline-none focus:border-blue-500">
                    <button onclick="connectToPeer(document.getElementById('remote-id').value)" class="bg-blue-600 hover:bg-blue-500 text-white px-3 rounded">
                        <i class="fa-solid fa-link"></i>
                    </button>
                </div>
            </div>
            
            <div id="status-log" class="text-xs font-mono text-gray-500 mt-auto h-32 overflow-y-auto p-2 rounded bg-black/20"></div>
        </div>

        <!-- Right Panel: Transfer Zone -->
        <div class="flex-1 bg-slate-900 relative flex flex-col">
            
            <!-- Drag Overlay -->
            <div id="drop-zone" class="absolute inset-0 bg-blue-600/10 z-50 hidden border-4 border-blue-500 border-dashed m-4 rounded-2xl flex items-center justify-center backdrop-blur-sm transition-all">
                <div class="text-center pointer-events-none">
                    <i class="fa-solid fa-cloud-arrow-up text-6xl text-blue-400 mb-4 animate-bounce"></i>
                    <h2 class="text-2xl font-bold text-white">Release to Send</h2>
                </div>
            </div>

            <!-- Empty State -->
            <div id="empty-state" class="flex-1 flex flex-col items-center justify-center text-gray-600">
                <div class="relative w-24 h-24 mb-6">
                    <div class="absolute inset-0 bg-blue-500/20 rounded-full pulse-ring"></div>
                    <div class="absolute inset-0 flex items-center justify-center bg-slate-800 rounded-full border border-gray-700">
                        <i class="fa-solid fa-satellite-dish text-3xl text-gray-500"></i>
                    </div>
                </div>
                <h3 class="text-xl font-semibold text-gray-400">Waiting for connection...</h3>
                <p class="text-sm mt-2 max-w-xs text-center text-gray-500">
                    Share the link or ID with another device.<br>
                    <span class="text-xs opacity-75">(Both must be on this page)</span>
                </p>
            </div>

            <!-- File List (Chat) -->
            <div id="file-list" class="flex-1 overflow-y-auto p-6 space-y-4 hidden no-scrollbar"></div>

            <!-- Action Bar -->
            <div class="p-4 bg-slate-800 border-t border-gray-700 hidden" id="action-bar">
                <div class="max-w-3xl mx-auto flex gap-4 items-center">
                    <input type="file" id="file-input" class="hidden" onchange="handleFiles(this.files)">
                    
                    <button onclick="document.getElementById('file-input').click()" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white py-4 rounded-xl font-bold shadow-lg shadow-blue-900/20 transition transform active:scale-95 flex items-center justify-center gap-2">
                        <i class="fa-solid fa-paper-plane"></i> Send File
                    </button>
                    
                    <div id="progress-container" class="hidden flex-1">
                        <div class="flex justify-between text-xs mb-1">
                            <span class="text-blue-400" id="progress-text">Sending...</span>
                            <span class="text-white" id="progress-percent">0%</span>
                        </div>
                        <div class="h-2 bg-gray-700 rounded-full overflow-hidden">
                            <div id="progress-bar" class="h-full bg-blue-500 w-0 transition-all duration-200"></div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        // --- Core Variables ---
        let peer;
        let conn;
        const CHUNK_SIZE = 16384 * 4; // 64KB chunks
        let myId = null;

        // --- DOM Elements ---
        const els = {
            qrCanvas: document.getElementById('qr-code'),
            myId: document.getElementById('my-id'),
            log: document.getElementById('status-log'),
            emptyState: document.getElementById('empty-state'),
            fileList: document.getElementById('file-list'),
            actionBar: document.getElementById('action-bar'),
            badge: document.getElementById('connection-badge'),
            dropZone: document.getElementById('drop-zone'),
            progressBox: document.getElementById('progress-container'),
            progressBar: document.getElementById('progress-bar'),
            progressText: document.getElementById('progress-text'),
            progressPercent: document.getElementById('progress-percent'),
            manualBox: document.getElementById('manual-connect-box'),
            qrContainer: document.getElementById('qr-container'),
            hostInstructions: document.getElementById('host-instructions')
        };

        // --- Initialization ---
        window.addEventListener('load', () => {
            // UI Check for Hosted vs Local
            if (window.location.protocol !== 'file:') {
                els.hostInstructions.classList.remove('hidden');
            }

            // Generate ID
            const randomId = 'wifi-' + Math.random().toString(36).substr(2, 6);
            
            // --- CRITICAL UPDATE: Add STUN Servers ---
            // This allows connections to work over the internet/Github Pages by punching through firewalls.
            peer = new Peer(randomId, { 
                debug: 1,
                config: {
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:global.stun.twilio.com:3478' }
                    ]
                }
            });

            peer.on('open', (id) => {
                myId = id;
                els.myId.textContent = id;
                generateQR();
                log(`Server Connected. My ID: ${id}`);
                
                // Auto-connect if URL has param
                const urlParams = new URLSearchParams(window.location.search);
                const remotePeer = urlParams.get('peer');
                if (remotePeer && remotePeer !== myId) {
                    log(`Found Peer ID in URL. Connecting to ${remotePeer}...`);
                    setTimeout(() => connectToPeer(remotePeer), 1000); // Small delay to ensure stability
                }
            });

            peer.on('connection', (c) => {
                handleConnection(c);
            });

            // Enhanced Error Handling
            peer.on('error', (err) => {
                console.error(err);
                let errorMsg = `Error: ${err.type}`;
                let showAlert = true;

                switch(err.type) {
                    case 'peer-unavailable':
                        errorMsg = "❌ Device not found. Is the link correct and the other tab open?";
                        break;
                    case 'network':
                        errorMsg = "❌ Network error. You are offline.";
                        break;
                    case 'disconnected':
                        errorMsg = "❌ Lost connection to server. Reconnecting...";
                        showAlert = false;
                        peer.reconnect();
                        break;
                    case 'browser-incompatible':
                        errorMsg = "❌ Browser incompatible. Use Chrome/Edge/Firefox.";
                        break;
                    default:
                        errorMsg = `❌ Error: ${err.type}`;
                }
                log(errorMsg);
                if(showAlert) alert(errorMsg);
            });

            setupDragDrop();
        });

        // --- Connection Logic ---
        function connectToPeer(id) {
            if(!id) return;
            log(`Initiating connection to ${id}...`);
            const c = peer.connect(id, { reliable: true });
            handleConnection(c);
        }

        function handleConnection(connection) {
            if(conn && conn.open) { 
                console.log("Already connected, ignoring new request");
                return; 
            } 
            
            conn = connection;
            
            // Timeout safety
            const connTimeout = setTimeout(() => {
                if(!conn.open) {
                    log("⚠️ Connection taking a while... Firewalls might be blocking it.");
                }
            }, 5000);

            conn.on('open', () => {
                clearTimeout(connTimeout);
                // UI Updates
                els.emptyState.classList.add('hidden');
                els.fileList.classList.remove('hidden');
                els.actionBar.classList.remove('hidden');
                els.manualBox.classList.add('hidden');
                els.qrContainer.classList.add('hidden');
                els.hostInstructions.classList.add('hidden');
                
                log(`✅ Connected to ${conn.peer}`);
                checkConnectionStats();
                setInterval(checkConnectionStats, 2000);
            });

            conn.on('data', handleData);
            
            conn.on('close', () => {
                resetUI();
                log('❌ Peer disconnected');
                alert('Connection lost');
            });

            conn.on('error', (err) => {
                log(`❌ Connection Error: ${err}`);
            });
        }

        // --- Connectivity Checks ---
        async function checkConnectionStats() {
            if(!conn || !conn.peerConnection) return;
            try {
                const stats = await conn.peerConnection.getStats();
                let isLocal = false;
                stats.forEach(report => {
                    if (report.type === 'candidate-pair' && report.state === 'succeeded') {
                        isLocal = true; // Simplified check
                    }
                });
                updateBadge(true); // Default to connected
            } catch (e) { console.log(e); }
        }

        function updateBadge(isLocal) {
            els.badge.classList.remove('hidden');
            // On public internet, "Local" detection is tricky, so we just show Connected
            els.badge.innerHTML = `<div class="w-2 h-2 rounded-full bg-green-500 shadow-[0_0_5px_#22c55e]"></div><span class="text-green-400">Connected</span>`;
            els.badge.className = "px-3 py-1 rounded-full text-xs font-bold bg-green-900/30 border border-green-500/30 flex items-center gap-2";
        }

        // --- Data Transfer ---
        function handleFiles(files) {
            if (!files.length || !conn) return;
            const file = files[0];
            conn.send({ type: 'meta', name: file.name, size: file.size, mime: file.type });
            addFileBubble(file.name, file.size, 'sent', null);
            els.progressBox.classList.remove('hidden');
            
            const reader = new FileReader();
            let offset = 0;
            reader.onload = (e) => {
                conn.send({ type: 'chunk', data: e.target.result });
                offset += e.target.result.byteLength;
                const pct = Math.round((offset / file.size) * 100);
                els.progressBar.style.width = pct + '%';
                els.progressPercent.textContent = pct + '%';
                if (offset < file.size) readSlice(offset);
                else {
                    els.progressBox.classList.add('hidden');
                    log('File sent successfully');
                }
            };
            const readSlice = (o) => reader.readAsArrayBuffer(file.slice(o, o + CHUNK_SIZE));
            readSlice(0);
        }

        let incoming = null;
        function handleData(data) {
            if (data.type === 'meta') {
                incoming = { name: data.name, size: data.size, mime: data.mime, buffer: [], received: 0 };
                log(`Receiving ${data.name}...`);
                els.progressBox.classList.remove('hidden');
                els.progressText.textContent = `Receiving ${data.name}...`;
            } else if (data.type === 'chunk' && incoming) {
                incoming.buffer.push(data.data);
                incoming.received += data.data.byteLength;
                const pct = Math.round((incoming.received / incoming.size) * 100);
                els.progressBar.style.width = pct + '%';
                els.progressPercent.textContent = pct + '%';
                if (incoming.received >= incoming.size) {
                    saveFile();
                }
            }
        }

        function saveFile() {
            const blob = new Blob(incoming.buffer, { type: incoming.mime });
            const url = URL.createObjectURL(blob);
            addFileBubble(incoming.name, incoming.size, 'received', url);
            els.progressBox.classList.add('hidden');
            incoming = null;
            log('File received');
        }

        // --- Helpers ---
        function generateQR() {
            const url = `${window.location.protocol}//${window.location.host}${window.location.pathname}?peer=${myId}`;
            new QRious({ element: els.qrCanvas, value: url, size: 180 });
        }
        function addFileBubble(name, size, type, url) {
            const isSent = type === 'sent';
            const div = document.createElement('div');
            div.className = `flex ${isSent ? 'justify-end' : 'justify-start'} animate-fade-in`;
            div.innerHTML = `
                <div class="${isSent ? 'bg-blue-600' : 'bg-slate-700'} p-4 rounded-2xl max-w-sm border border-white/5 shadow-lg">
                    <div class="flex items-center gap-4">
                        <div class="bg-black/20 p-3 rounded-lg"><i class="fa-solid ${isSent ? 'fa-upload' : 'fa-download'} text-xl text-white"></i></div>
                        <div class="overflow-hidden">
                            <p class="font-bold text-white text-sm truncate w-40">${name}</p>
                            <p class="text-xs text-blue-200 mt-1">${formatBytes(size)}</p>
                        </div>
                    </div>
                    ${url ? `<a href="${url}" download="${name}" class="mt-3 block w-full bg-white/10 hover:bg-white/20 text-center py-2 rounded text-sm font-bold text-white transition">Save File</a>` : ''}
                </div>`;
            els.fileList.appendChild(div);
            els.fileList.scrollTop = els.fileList.scrollHeight;
        }
        function resetUI() {
            conn = null;
            els.emptyState.classList.remove('hidden');
            els.fileList.classList.add('hidden');
            els.actionBar.classList.add('hidden');
            els.manualBox.classList.remove('hidden');
            els.qrContainer.classList.remove('hidden');
            els.hostInstructions.classList.remove('hidden');
            els.badge.classList.add('hidden');
            els.fileList.innerHTML = '';
        }
        function log(msg) { els.log.prepend(Object.assign(document.createElement('div'), { textContent: `> ${msg}` })); }
        function formatBytes(b) { if(!b) return '0B'; const k=1024, i=Math.floor(Math.log(b)/Math.log(k)); return parseFloat((b/Math.pow(k,i)).toFixed(1)) + ['B','KB','MB','GB'][i]; }
        
        function copyToClipboard(text) {
            const ta = document.createElement("textarea");
            ta.value = text;
            ta.style.position="fixed"; ta.style.opacity="0";
            document.body.appendChild(ta);
            ta.select();
            document.execCommand('copy');
            document.body.removeChild(ta);
        }
        function copyLink() {
            copyToClipboard(`${window.location.protocol}//${window.location.host}${window.location.pathname}?peer=${myId}`);
            alert("Link copied! Send it to the other device.");
        }
        function copyId() { copyToClipboard(myId); alert("ID Copied"); }
        function setupDragDrop() {
            window.addEventListener('dragenter', () => els.dropZone.classList.remove('hidden'));
            els.dropZone.addEventListener('dragleave', () => els.dropZone.classList.add('hidden'));
            els.dropZone.addEventListener('dragover', e => e.preventDefault());
            els.dropZone.addEventListener('drop', e => { e.preventDefault(); els.dropZone.classList.add('hidden'); handleFiles(e.dataTransfer.files); });
        }
    </script>
</body>
</html>
